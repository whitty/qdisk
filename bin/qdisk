#!/usr/bin/env ruby

require 'qdisk'
require 'optparse'

include QDisk

begin

  options, arguments = parse_options(ARGV)

  if arguments.length > 0
    if options.fetch(:best, false) and (options[:query].nil? or options[:query].length == 0)
      options[:query] = [[:interface, 'usb'], :mounted?]
    end

    case arguments.shift
    when 'unmount'
      unmount(options)
    when 'cp'
      begin
        cp(arguments, options)
      rescue SystemCallError => e
        puts e.message
        exit(3)
      end
    end
  end

rescue OptionParser::ParseError
  exit(1)
rescue NotFound, MissingRequiredArgument, UnknownCommand => e
  puts e.message
  exit(e.code)
end
